<html>
<head>
  <script src="https://cdn.anychart.com/releases/8.7.0/js/anychart-bundle.min.js"></script>
</head>

<script type="text/javascript">
	var xhr = new XMLHttpRequest();
	xhr.open('GET', '/stat', false);
	xhr.send();
	var stat_file = xhr.responseText;
	console.log(stat_file);
	
	xhr.open('GET', '/data', false);
	xhr.send();
	var data_file = xhr.responseText;
	console.log(data_file);
	
	anychart.onDocumentReady(function () {
		anychart.data.loadJsonFile(data_file, function (data) {
			// set the data
			var table = anychart.data.table('StartTime');
			
			table.addData(data);
		  
			// map the data
			mapping = table.mapAs({'open':"Open",'high': "High", 'low':"Low", 'close':"Close"});
			var chart = anychart.stock();

			// set the series
			var series = chart.plot(0).candlestick(mapping);			
			var tooltip = series.tooltip();
			series.normal().fallingFill("red");
			series.normal().fallingStroke("red");
			series.normal().risingFill("green");
			series.normal().risingStroke("green");
			chart.tooltip().background().fill("AliceBlue");
			chart.tooltip().title().fontColor("black");
			chart.tooltip().titleFormat('{%x}{dateTimeFormat:yyyy.MM.dd HH:mm}');
			chart.crosshair().xLabel().format('{%Value}{dateTimeFormat:yyyy.MM.dd}');
			tooltip.format(function() {
				//console.log(this);
				var change = ((this.close - this.open) / this.open) * 100;
				//console.log(change.toFixed(2));
				if(change >= 0) {
					chart.tooltip().fontColor("green");
				}else {
					chart.tooltip().fontColor("red");
				}

				return "Open: " + this.open
				  + "\nHigh: " + this.high + "\nLow: " + this.low 
					+ "\nClose: " + this.close + "\nChange: " + change.toFixed(2) + "%";
			});
			
			chart.plot(0).legend().titleFormat('{%value}{dateTimeFormat:yyyy.MM.dd HH:mm}');
			series.legendItem().format(function() {
				
				var change = ((this.close - this.open) / this.open) * 100;
				//console.log(this);

				return "(" + data[0].Symbol + "; " + data[0].Interval + "; O: " + this.open
				  + "; H: " + this.high + "; L: " + this.low 
					+ "; C: " + this.close + "; Change: " + change.toFixed(2) + "%)";
			});

			//series.name(' ');
			
			chart.title(data[0].Symbol + ', ' + data[0].Interval + ', ' + timeConverter(data[0].StartTime)
			  + ' - ' + timeConverter(data[data.length - 1].EndTime));
			
			
			anychart.data.loadJsonFile(stat_file, function (json) {
				//console.log(json.orders[0].entry.time);
				console.log(json);
				var controller = chart.plot(0).annotations();
				var verticalLine1 = controller.verticalLine({
					xAnchor: json.start_time,
				}).allowEdit(false);
				verticalLine1.stroke("grey", 4, "10 2");
				
				var verticalLine2 = controller.verticalLine({
					xAnchor: json.end_time,
				}).allowEdit(false);
				verticalLine2.stroke("grey", 4, "10 2");
				
				var markers = [];
				
				for(var i = 0; json.orders[i]; i++) {
					//console.log(json.orders[i]);
					markers.push({"date": json.orders[i].exit.time, "description": json.orders[i].stat.profit});
					//annotation.allowEdit(false);
					// create a Vertical Channel annotation
					var ver_Range = controller.verticalRange({
						xAnchor: json.orders[i].entry.time,
						secondXAnchor: json.orders[i].exit.time,
					}).allowEdit(false);

					if (json.orders[i].stat.profit > 0) {
						ver_Range.fill("green", 0.3).stroke("green");
					}else {
						ver_Range.fill("red", 0.3).stroke("red");
					}
				}
				var eventMarkers = chart.plot(0).eventMarkers();
				eventMarkers.data(markers);
			});
			
			chart.container('plot');
			chart.draw();
		});
	});
	function timeConverter(UNIX_timestamp) {
		var a = new Date(UNIX_timestamp);
		//console.log(a);
		
		var numformat = new Intl.NumberFormat("en-US",
                        { minimumIntegerDigits: 2 });
		
		var months = ['01','02','03','04','05','06','07','08','09','10','11','12'];
		var year = a.getUTCFullYear();
		var month = months[a.getUTCMonth()];
		var date = numformat.format(a.getUTCDate());
		var hour = numformat.format(a.getUTCHours());
		var min = numformat.format(a.getUTCMinutes());
		//var sec = a.getUTCSeconds();
		var time = year + '.' + month + '.' + date + ' ' + hour + ':' + min;// + ':' + sec ;
		return time;
	}
</script>
<body>
	<div id="plot"></div>
</body>
</html>
